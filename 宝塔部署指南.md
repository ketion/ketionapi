# New-API å®å¡”é¢æ¿éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—é€‚ç”¨äºåœ¨å®å¡”é¢æ¿ä¸Šéƒ¨ç½²äºŒæ¬¡å¼€å‘ç‰ˆæœ¬çš„ New-APIï¼ˆæ”¯æŒé­”å¡”å¹³å°æ–‡ç”Ÿå›¾ï¼‰ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- å®å¡”é¢æ¿ 7.x æˆ–æ›´é«˜ç‰ˆæœ¬
- æœåŠ¡å™¨å†…å­˜è‡³å°‘ 2GB
- ç£ç›˜ç©ºé—´è‡³å°‘ 10GB

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæœ¬åœ°æ„å»º Docker é•œåƒ

åœ¨ä½ çš„å¼€å‘æœºå™¨ä¸Šï¼ˆWindowsï¼‰ï¼š

1. æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼Œè¿›å…¥é¡¹ç›®ç›®å½•
2. è¿è¡Œæ„å»ºè„šæœ¬ï¼š
   ```cmd
   build-and-export.bat
   ```
3. é€‰æ‹© `Y` å¯¼å‡ºé•œåƒæ–‡ä»¶
4. ç­‰å¾…æ„å»ºå®Œæˆï¼Œä¼šç”Ÿæˆ `new-api-modelscope-x.x.x.tar` æ–‡ä»¶

### ç¬¬äºŒæ­¥ï¼šä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

å°†ä»¥ä¸‹æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆå»ºè®®è·¯å¾„ï¼š`/opt/new-api`ï¼‰ï¼š

- `new-api-modelscope-x.x.x.tar` ï¼ˆé•œåƒæ–‡ä»¶ï¼‰
- `docker-compose.yml` ï¼ˆéƒ¨ç½²é…ç½®ï¼‰

å¯ä»¥ä½¿ç”¨å®å¡”é¢æ¿çš„æ–‡ä»¶ç®¡ç†åŠŸèƒ½ä¸Šä¼ ï¼Œæˆ–ä½¿ç”¨ SFTP å·¥å…·ã€‚

### ç¬¬ä¸‰æ­¥ï¼šå®‰è£… Docker

åœ¨å®å¡”é¢æ¿ä¸­ï¼š

1. è¿›å…¥ **è½¯ä»¶å•†åº—**
2. æœç´¢ **Docker**
3. ç‚¹å‡» **å®‰è£…**
4. ç­‰å¾…å®‰è£…å®Œæˆ

å®‰è£…å®Œæˆåï¼ŒDocker Compose ä¼šè‡ªåŠ¨å®‰è£…ã€‚

### ç¬¬å››æ­¥ï¼šå¯¼å…¥é•œåƒå¹¶å¯åŠ¨æœåŠ¡

1. åœ¨å®å¡”é¢æ¿ä¸­æ‰“å¼€ **ç»ˆç«¯**
2. è¿›å…¥éƒ¨ç½²ç›®å½•ï¼š
   ```bash
   cd /opt/new-api
   ```

3. å¯¼å…¥ Docker é•œåƒï¼š
   ```bash
   docker load -i new-api-modelscope-x.x.x.tar
   ```

4. éªŒè¯é•œåƒå¯¼å…¥æˆåŠŸï¼š
   ```bash
   docker images | grep new-api-modelscope
   ```

5. å¯åŠ¨æœåŠ¡ï¼š
   ```bash
   docker-compose up -d
   ```

6. æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š
   ```bash
   docker-compose ps
   ```

### ç¬¬äº”æ­¥ï¼šé…ç½®é˜²ç«å¢™å’Œåå‘ä»£ç†

#### æ–¹æ³• 1ï¼šç›´æ¥è®¿é—®ï¼ˆç®€å•ï¼‰

1. åœ¨å®å¡”é¢æ¿ **å®‰å…¨** ä¸­æ”¾è¡Œ **3000** ç«¯å£
2. è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP:3000`

#### æ–¹æ³• 2ï¼šä½¿ç”¨åå‘ä»£ç†ï¼ˆæ¨èï¼‰

1. åœ¨å®å¡”é¢æ¿ä¸­åˆ›å»ºç½‘ç«™ï¼ˆä¾‹å¦‚ï¼š`api.yourdomain.com`ï¼‰
2. ç‚¹å‡»ç½‘ç«™è®¾ç½® â†’ **åå‘ä»£ç†**
3. æ·»åŠ åå‘ä»£ç†ï¼š
   - ä»£ç†åç§°ï¼š`new-api`
   - ç›®æ ‡URLï¼š`http://127.0.0.1:3000`
   - å‘é€åŸŸåï¼š`$host`
4. ä¿å­˜å¹¶å¯ç”¨
5. å¯é€‰ï¼šç”³è¯· SSL è¯ä¹¦ï¼Œå¯ç”¨ HTTPS

### ç¬¬å…­æ­¥ï¼šé¦–æ¬¡ç™»å½•é…ç½®

1. è®¿é—®éƒ¨ç½²çš„åœ°å€
2. ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š
   - ç”¨æˆ·åï¼š`root`
   - å¯†ç ï¼š`123456`
3. **ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç **
4. é…ç½®é­”å¡”å¹³å°çš„ API å¯†é’¥å’Œç«¯ç‚¹

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æ—¥å¿—
```bash
cd /opt/new-api
docker-compose logs -f new-api
```

### é‡å¯æœåŠ¡
```bash
docker-compose restart
```

### åœæ­¢æœåŠ¡
```bash
docker-compose down
```

### æ›´æ–°æœåŠ¡
```bash
# 1. ä¸Šä¼ æ–°çš„é•œåƒæ–‡ä»¶
# 2. å¯¼å…¥æ–°é•œåƒ
docker load -i new-api-modelscope-æ–°ç‰ˆæœ¬.tar

# 3. é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d
```

### å¤‡ä»½æ•°æ®
```bash
# å¤‡ä»½æ•°æ®åº“
docker exec new-api-postgres pg_dump -U newapi newapi > backup-$(date +%Y%m%d).sql

# å¤‡ä»½æ•°æ®ç›®å½•
tar -czf data-backup-$(date +%Y%m%d).tar.gz ./data
```

### æ¢å¤æ•°æ®
```bash
# æ¢å¤æ•°æ®åº“
docker exec -i new-api-postgres psql -U newapi newapi < backup-20260110.sql
```

## âš™ï¸ é…ç½®è¯´æ˜

### ä¿®æ”¹ç«¯å£

ç¼–è¾‘ `docker-compose.yml`ï¼Œä¿®æ”¹ ports éƒ¨åˆ†ï¼š
```yaml
ports:
  - "8080:3000"  # æ”¹ä¸º 8080 ç«¯å£
```

### ä¿®æ”¹æ•°æ®åº“å¯†ç 

1. ç¼–è¾‘ `docker-compose.yml`
2. ä¿®æ”¹ä»¥ä¸‹ä¸¤å¤„ï¼š
   ```yaml
   # new-api æœåŠ¡çš„ç¯å¢ƒå˜é‡
   - SQL_DSN=postgresql://newapi:æ–°å¯†ç @postgres:5432/newapi
   
   # postgres æœåŠ¡çš„ç¯å¢ƒå˜é‡
   POSTGRES_PASSWORD: æ–°å¯†ç 
   ```
3. é‡æ–°å¯åŠ¨æœåŠ¡

### å¯ç”¨å¤šæœºéƒ¨ç½²

å¦‚æœéœ€è¦éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œåœ¨ `docker-compose.yml` ä¸­å–æ¶ˆæ³¨é‡Šï¼š
```yaml
- SESSION_SECRET=your_random_secret_string_here
```
æ‰€æœ‰å®ä¾‹ä½¿ç”¨ç›¸åŒçš„ SESSION_SECRET å€¼ã€‚

## ğŸ› æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

1. æŸ¥çœ‹æ—¥å¿—ï¼š
   ```bash
   docker-compose logs
   ```

2. æ£€æŸ¥ç«¯å£å ç”¨ï¼š
   ```bash
   netstat -tlnp | grep 3000
   ```

3. æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š
   ```bash
   df -h
   ```

### æ— æ³•è®¿é—®æœåŠ¡

1. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
2. æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œï¼š
   ```bash
   docker ps | grep new-api
   ```
3. æ£€æŸ¥åå‘ä»£ç†é…ç½®

### æ•°æ®åº“è¿æ¥å¤±è´¥

1. æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€ï¼š
   ```bash
   docker ps | grep postgres
   ```

2. æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼š
   ```bash
   docker logs new-api-postgres
   ```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å†…å­˜ä¼˜åŒ–**ï¼šå¦‚æœæœåŠ¡å™¨å†…å­˜æœ‰é™ï¼Œå¯ä»¥é™åˆ¶å®¹å™¨å†…å­˜ä½¿ç”¨
2. **æ—¥å¿—ç®¡ç†**ï¼šå®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…å ç”¨è¿‡å¤šç£ç›˜ç©ºé—´
3. **æ•°æ®åº“ä¼˜åŒ–**ï¼šå®šæœŸæ‰§è¡Œ VACUUM æ“ä½œ
4. **ä½¿ç”¨ CDN**ï¼šä¸ºé™æ€èµ„æºé…ç½® CDN åŠ é€Ÿ

## ğŸ”’ å®‰å…¨å»ºè®®

1. âœ… ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
2. âœ… å¯ç”¨ HTTPSï¼ˆä½¿ç”¨å®å¡”é¢æ¿ç”³è¯·å…è´¹ SSL è¯ä¹¦ï¼‰
3. âœ… é…ç½®é˜²ç«å¢™ï¼Œåªå¼€æ”¾å¿…è¦ç«¯å£
4. âœ… å®šæœŸå¤‡ä»½æ•°æ®
5. âœ… å®šæœŸæ›´æ–°é•œåƒç‰ˆæœ¬
6. âœ… ä½¿ç”¨å¼ºå¯†ç å’Œå¯†é’¥
7. âœ… é™åˆ¶ç®¡ç†å‘˜è´¦å·æ•°é‡

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Docker å’Œ Docker Compose ç‰ˆæœ¬
2. æœåŠ¡å™¨ç³»ç»Ÿæ—¥å¿—
3. å®¹å™¨æ—¥å¿—
4. ç½‘ç»œè¿æ¥çŠ¶æ€

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰
